<!DOCTYPE html>
<html>
<head>
    <title>Detail Page Test - Port 3011</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .link { color: blue; text-decoration: underline; margin: 10px 0; display: block; }
        .info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>é€£çµ¡å…ˆè©³ç´°ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ (Port 3011)</h1>
    
    <div class="info">
        <strong>ğŸ“ ã‚µãƒ¼ãƒãƒ¼æƒ…å ±:</strong><br>
        URL: http://localhost:3011<br>
        ãƒãƒ¼ãƒˆ: 3011<br>
        <span id="server-status">ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</span>
    </div>
    
    <h2>ğŸ”— è©³ç´°ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯</h2>
    <div id="links">
        <p>é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <h2>ğŸ“Š API ãƒ†ã‚¹ãƒˆçµæœ</h2>
    <div id="api-status">
        <p>APIã‚’ãƒ†ã‚¹ãƒˆä¸­...</p>
    </div>

    <h2>ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
    <pre id="debug" style="background: #f5f5f5; padding: 10px; border-radius: 5px;"></pre>

    <script>
        let debugInfo = '';
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addDebug(message) {
            debugInfo += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('debug').textContent = debugInfo;
        }
        
        // ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3011/');
                if (response.ok) {
                    document.getElementById('server-status').innerHTML = 
                        '<span class="success">âœ… ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒä¸­</span>';
                    addDebug('Server is running on port 3011');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = 
                    '<span class="error">âŒ ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—: ' + error.message + '</span>';
                addDebug('Server connection failed: ' + error.message);
                return false;
            }
        }
        
        // APIãƒ†ã‚¹ãƒˆ
        async function testAPI() {
            const apiStatus = document.getElementById('api-status');
            
            try {
                addDebug('Testing contacts API...');
                const response = await fetch('http://localhost:3011/api/contacts?limit=5');
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                addDebug(`API response: ${data.data?.length || 0} contacts found`);
                
                if (!data.data || data.data.length === 0) {
                    apiStatus.innerHTML = '<span class="error">âŒ é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
                    return null;
                }
                
                apiStatus.innerHTML = '<span class="success">âœ… APIæ­£å¸¸å‹•ä½œ (' + data.data.length + 'ä»¶ã®é€£çµ¡å…ˆ)</span>';
                return data.data;
                
            } catch (error) {
                apiStatus.innerHTML = '<span class="error">âŒ API ã‚¨ãƒ©ãƒ¼: ' + error.message + '</span>';
                addDebug('API error: ' + error.message);
                return null;
            }
        }
        
        // è©³ç´°ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
        function generateDetailLinks(contacts) {
            const linksContainer = document.getElementById('links');
            
            if (!contacts || contacts.length === 0) {
                linksContainer.innerHTML = '<p class="error">é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const linkHtml = contacts.map((contact, index) => {
                const detailUrl = `http://localhost:3011/contacts/${contact.id}`;
                return `
                    <div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <strong>${index + 1}. ${contact.fullName}</strong><br>
                        <small>ä¼šç¤¾: ${contact.company?.name || 'æœªè¨­å®š'}</small><br>
                        <small>ID: ${contact.id}</small><br>
                        <a href="${detailUrl}" target="_blank" class="link">
                            ğŸ“„ è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                        </a>
                        <button onclick="testDetailAPI('${contact.id}')" style="margin-left: 10px; padding: 5px 10px;">
                            ğŸ§ª APIãƒ†ã‚¹ãƒˆ
                        </button>
                    </div>
                `;
            }).join('');
            
            linksContainer.innerHTML = linkHtml;
            
            addDebug(`Generated ${contacts.length} detail page links`);
        }
        
        // è©³ç´°APIå€‹åˆ¥ãƒ†ã‚¹ãƒˆ
        async function testDetailAPI(contactId) {
            try {
                addDebug(`Testing detail API for contact: ${contactId}`);
                const response = await fetch(`http://localhost:3011/api/contacts/${contactId}/detail`);
                
                if (!response.ok) {
                    throw new Error(`Detail API returned ${response.status}`);
                }
                
                const detail = await response.json();
                
                if (detail.contact) {
                    addDebug(`âœ… Detail API success: ${detail.contact.fullName}`);
                    alert(`âœ… è©³ç´°APIæˆåŠŸ!\nåå‰: ${detail.contact.fullName}\nä¼šç¤¾: ${detail.contact.company?.name || 'æœªè¨­å®š'}`);
                } else {
                    throw new Error('No contact data in response');
                }
                
            } catch (error) {
                addDebug(`âŒ Detail API error for ${contactId}: ${error.message}`);
                alert('âŒ è©³ç´°API ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
        async function main() {
            addDebug('Starting detail page test...');
            
            // ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª
            const serverOk = await checkServerStatus();
            if (!serverOk) {
                addDebug('Server check failed, stopping test');
                return;
            }
            
            // APIãƒ†ã‚¹ãƒˆ
            const contacts = await testAPI();
            
            // è©³ç´°ãƒªãƒ³ã‚¯ç”Ÿæˆ
            generateDetailLinks(contacts);
            
            addDebug('Test completed');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>