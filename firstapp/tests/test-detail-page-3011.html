<!DOCTYPE html>
<html>
<head>
    <title>Detail Page Test - Port 3011</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .link { color: blue; text-decoration: underline; margin: 10px 0; display: block; }
        .info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>連絡先詳細ページテスト (Port 3011)</h1>
    
    <div class="info">
        <strong>📍 サーバー情報:</strong><br>
        URL: http://localhost:3011<br>
        ポート: 3011<br>
        <span id="server-status">サーバー状態を確認中...</span>
    </div>
    
    <h2>🔗 詳細ページリンク</h2>
    <div id="links">
        <p>連絡先データを読み込み中...</p>
    </div>

    <h2>📊 API テスト結果</h2>
    <div id="api-status">
        <p>APIをテスト中...</p>
    </div>

    <h2>🐛 デバッグ情報</h2>
    <pre id="debug" style="background: #f5f5f5; padding: 10px; border-radius: 5px;"></pre>

    <script>
        let debugInfo = '';
        
        // デバッグ情報を追加する関数
        function addDebug(message) {
            debugInfo += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('debug').textContent = debugInfo;
        }
        
        // サーバー状態確認
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3011/');
                if (response.ok) {
                    document.getElementById('server-status').innerHTML = 
                        '<span class="success">✅ サーバー稼働中</span>';
                    addDebug('Server is running on port 3011');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = 
                    '<span class="error">❌ サーバー接続失敗: ' + error.message + '</span>';
                addDebug('Server connection failed: ' + error.message);
                return false;
            }
        }
        
        // APIテスト
        async function testAPI() {
            const apiStatus = document.getElementById('api-status');
            
            try {
                addDebug('Testing contacts API...');
                const response = await fetch('http://localhost:3011/api/contacts?limit=5');
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                addDebug(`API response: ${data.data?.length || 0} contacts found`);
                
                if (!data.data || data.data.length === 0) {
                    apiStatus.innerHTML = '<span class="error">❌ 連絡先データが見つかりません</span>';
                    return null;
                }
                
                apiStatus.innerHTML = '<span class="success">✅ API正常動作 (' + data.data.length + '件の連絡先)</span>';
                return data.data;
                
            } catch (error) {
                apiStatus.innerHTML = '<span class="error">❌ API エラー: ' + error.message + '</span>';
                addDebug('API error: ' + error.message);
                return null;
            }
        }
        
        // 詳細ページリンクを生成
        function generateDetailLinks(contacts) {
            const linksContainer = document.getElementById('links');
            
            if (!contacts || contacts.length === 0) {
                linksContainer.innerHTML = '<p class="error">連絡先データがありません</p>';
                return;
            }
            
            const linkHtml = contacts.map((contact, index) => {
                const detailUrl = `http://localhost:3011/contacts/${contact.id}`;
                return `
                    <div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <strong>${index + 1}. ${contact.fullName}</strong><br>
                        <small>会社: ${contact.company?.name || '未設定'}</small><br>
                        <small>ID: ${contact.id}</small><br>
                        <a href="${detailUrl}" target="_blank" class="link">
                            📄 詳細ページを開く
                        </a>
                        <button onclick="testDetailAPI('${contact.id}')" style="margin-left: 10px; padding: 5px 10px;">
                            🧪 APIテスト
                        </button>
                    </div>
                `;
            }).join('');
            
            linksContainer.innerHTML = linkHtml;
            
            addDebug(`Generated ${contacts.length} detail page links`);
        }
        
        // 詳細API個別テスト
        async function testDetailAPI(contactId) {
            try {
                addDebug(`Testing detail API for contact: ${contactId}`);
                const response = await fetch(`http://localhost:3011/api/contacts/${contactId}/detail`);
                
                if (!response.ok) {
                    throw new Error(`Detail API returned ${response.status}`);
                }
                
                const detail = await response.json();
                
                if (detail.contact) {
                    addDebug(`✅ Detail API success: ${detail.contact.fullName}`);
                    alert(`✅ 詳細API成功!\n名前: ${detail.contact.fullName}\n会社: ${detail.contact.company?.name || '未設定'}`);
                } else {
                    throw new Error('No contact data in response');
                }
                
            } catch (error) {
                addDebug(`❌ Detail API error for ${contactId}: ${error.message}`);
                alert('❌ 詳細API エラー: ' + error.message);
            }
        }
        
        // メイン実行
        async function main() {
            addDebug('Starting detail page test...');
            
            // サーバー状態確認
            const serverOk = await checkServerStatus();
            if (!serverOk) {
                addDebug('Server check failed, stopping test');
                return;
            }
            
            // APIテスト
            const contacts = await testAPI();
            
            // 詳細リンク生成
            generateDetailLinks(contacts);
            
            addDebug('Test completed');
        }
        
        // ページ読み込み完了後に実行
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>